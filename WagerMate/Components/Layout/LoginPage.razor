@page "/login"
@using System.ComponentModel.DataAnnotations

@layout LoginLayout
@rendermode InteractiveServer
@inject IUserService UserService;
@inject NavigationManager Navigation
@inject ICookieService CookieService;
@inject IHashService HashService

<div class="column">
    <div id="leftSide" class="half">
        <h1>WagerMate</h1>

        <p>Welcome Back!</p>

        <EditForm Model="@_existingUserData" OnValidSubmit="HandleLogin" FormName="FormLogin" method="post">
            <DataAnnotationsValidator/>
            <div class="field">
                <div>
                    <label>E-mail address:</label>
                </div>
                <InputText class="input" @bind-Value="_existingUserData.EMail"/>
                <ValidationMessage For="@(() => _existingUserData.EMail)"/>
            </div>
            <div class="field">
                <div>
                    <label>Password:</label>
                </div>
                <InputText class="input" type="password" @bind-Value="_existingUserData.Password"/>
                <ValidationMessage For="@(() => _existingUserData.Password)"/>
            </div>
            <div id="loginspace">
                <input id="login" type="submit" value="Log in"/>
            </div>
        </EditForm>
    </div>

    <div id="rightSide" class="half">
        <h1>WagerMate</h1>

        <p>Welcome Mate!</p>

        <EditForm Model="@_newUserData" OnValidSubmit="HandleRegister" FormName="FormRegister">
            <DataAnnotationsValidator/>
            <div class="field">
                <div>
                    <label>Username:</label>
                </div>
                <InputText class="input" @bind-Value="_newUserData.Username"/>
                <ValidationMessage For="@(() => _newUserData.Username)"/>
            </div>
            <div class="field">
                <div>
                    <label>E-mail address:</label>
                </div>
                <InputText class="input" @bind-Value="_newUserData.EMail"/>
                <ValidationMessage For="@(() => _newUserData.EMail)"/>
                @if (!string.IsNullOrEmpty(errorMessageRegistrationEMail))
                {
                    @errorMessageRegistrationEMail
                }
            </div>
            <div class="field">
                <div>
                    <label>Password:</label>
                </div>
                <InputText class="input" type="password" @bind-Value="_newUserData.Password"/>
                <ValidationMessage For="@(() => _newUserData.Password)"/>
            </div>
            <div class="field">
                <div>
                    <label>Repeat Password:</label>
                </div>
                <InputText class="input" type="password" @bind-Value="_newUserData.PasswordRepeat"/>
                <ValidationMessage For="@(() => _newUserData.PasswordRepeat)"/>
            </div>
            <div class="field">
                <div>
                    <label>Enter Invite Code:</label>
                </div>
                <InputText class="input" @bind-Value="_newUserData.InviteCode"/>
                <ValidationMessage For="@(() => _newUserData.InviteCode)"/>
            </div>
            <div id="registerspace">
                <input id="register" type="submit" value="Register">
            </div>
        </EditForm>
    </div>
</div>


@code {
    private readonly ExistingUserData _existingUserData = new();

    public class ExistingUserData
    {
        [Required(ErrorMessage = "E-mail address is required!")]
        [EmailAddress(ErrorMessage = "Invalid e-mail address!")]
        //[Compare("PasswordValidation", ErrorMessage = "No account with this e-mail address!")]
        public string? EMail { get; set; }

        public string? EMailValidation { get; set; }

        [Required(ErrorMessage = "Password is required!")]
        public string? Password { get; set; }

        public string? PasswordValidation { get; set; }
    }

    private readonly NewUserData _newUserData = new();

    public class NewUserData
    {
        [Required(ErrorMessage = "E-mail address is required!")]
        [EmailAddress(ErrorMessage = "Invalid e-mail address!")]
        public string? EMail { get; set; }

        [Required(ErrorMessage = "Username is required!")]
        public string? Username { get; set; }

        [Required(ErrorMessage = "Password is required!")]
        public string? Password { get; set; }

        [Required(ErrorMessage = "Repetition of password is required!")]
        [Compare("Password", ErrorMessage = "Must match Password!")]
        public string? PasswordRepeat { get; set; }

        [Required(ErrorMessage = "Invite code is required!")]
        [CompareInviteCode("42", ErrorMessage = "Invalid invite code!")]
        public string? InviteCode { get; set; }
    }

    public class CompareInviteCodeAttribute : ValidationAttribute
    {
        private readonly string _validCode;

        public CompareInviteCodeAttribute(string validCode)
        {
            _validCode = validCode;
        }

        protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)
        {
            if (value == null || value.ToString() != _validCode)
            {
                return new ValidationResult(ErrorMessage ?? "Invalid invite code!");
            }

            return ValidationResult.Success;
        }
    }


    private async Task HandleLogin()
    {
        try
        {
            var user = UserService.GetUserByEmail(_existingUserData.EMail!);
            if (HashService.CreateHash(_existingUserData.Password!, _existingUserData.EMail!).Equals(user.Password))
            {
                Console.WriteLine("Login successful.");
                await CookieService.SetCookieByNameAndValue("CookieID", user.Password, 7);

                Navigation.NavigateTo("/");
            }
            else
            {
                Console.WriteLine("Invalid password.");
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            Console.WriteLine("Not registered E-Mail.");
        }
    }

    private string? errorMessageRegistrationEMail;

    public async Task HandleRegister()
    {
        if (!UserService.EmailIsRegistered(_newUserData.EMail!))
        {
            var result = RegisterUser();
            if (result.Password != null)
            {
                await CookieService.SetCookieByNameAndValue("CookieID", result.Password, 7);
                Navigation.NavigateTo("/");
            }
        }
        else
        {
            Console.WriteLine("E-Mail is already taken.");
            errorMessageRegistrationEMail = "E-Mail is already taken!";
        }
    }

    private User RegisterUser()
    {
        Console.WriteLine("Register New User");
        var user2 = new User();
        user2.Name = _newUserData.Username;
        user2.Email = _newUserData.EMail;
        user2.Password = HashService.CreateHash(_newUserData.Password!, _newUserData.EMail!);

        Console.WriteLine("user locally registered");
        try
        {
            UserService.CreateUser(user2);
            return user2;
        }
        catch (Exception)
        {
            Console.WriteLine("service failed");
            throw;
        }
    }
}
